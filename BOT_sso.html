<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Grazitti.AI - GraziInsight365</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="" name="keywords">
  <meta content="" name="description">

  <!-- Bot Framework WebChat and MSAL libraries -->
  <script crossorigin="anonymous" src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script type="text/javascript">
    if (typeof msal === 'undefined') {
      document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/browser/2.32.0/js/msal-browser.min.js' type='text/javascript'%3E%3C/script%3E"));
    }
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Ubuntu:wght@500;700&display=swap" rel="stylesheet">  
</head>

<body>
  <!-- Chat Container -->
  <div id="chatContainer" style="display: block;">
    <div id="chatHeader">
      <img src="ser_Insight365_BotImage" alt="Bot">
      Insight365
    </div>
    <div id="webchat" role="main"></div>
  </div>

  <!-- Chat SSO Script -->
  <script type="text/javascript">
       const clientId = "da8ed98a-6528-4409-bd9a-854ec6508053"
        const tenantId = "cb80a1cd-6550-4e99-8c5a-1aa822ecea1e"
    const tokenEndpoint = "https://defaultcb80a1cd65504e998c5a1aa822ecea.1e.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cra88_demoAgent/directline/token?api-version=2022-03-01-preview";

    const msalConfig = {
      auth: {
        clientId: clientId,
        authority: "https://login.microsoftonline.com/" + tenantId,
        redirectUri: "https://chandninegi.github.io/CopilotAgent/",
      },
      cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: true,
      },
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    async function onSignInClick() {
      alert("danger..");
      const loginRequest = {
        scopes: ["User.Read", "openid", "profile"],
      };
      try {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          msalInstance.setActiveAccount(accounts[0]);
          user = accounts[0];
          await renderChatWidget();
        } else {
          try {
            const response = await msalInstance.ssoSilent(loginRequest);
            user = response.account;
            msalInstance.setActiveAccount(user);
            await renderChatWidget();
          } catch (err) {
            try {
              const loginResponse = await msalInstance.loginPopup(loginRequest);
              user = loginResponse.account;
              msalInstance.setActiveAccount(user);
              await renderChatWidget();
            } catch (err) {
              console.log(err);
              return;
            }
          }
        }
      } catch (err) {
        console.log(err);
      }
    }

    async function onSignOutClick() {
      result = await msalInstance.logoutPopup({
        account: user,
      });
      location.reload();
    }

    window.onload = function () {
      onSignInClick();
    };

    function getOAuthCardResourceUri(activity) {
      if (
        activity &&
        activity.attachments &&
        activity.attachments[0] &&
        activity.attachments[0].contentType === "application/vnd.microsoft.card.oauth" &&
        activity.attachments[0].content.tokenExchangeResource
      ) {
        return activity.attachments[0].content.tokenExchangeResource.uri;
      }
    }

    async function exchangeTokenAsync(resourceUri) {
      let user = msalInstance.getAllAccounts();
      if (user.length <= 0) return null;

      const tokenRequest = { scopes: [resourceUri] };
      try {
        const tokenResponse = await msalInstance.acquireTokenSilent(tokenRequest);
        return tokenResponse.accessToken;
      } catch (err) {
        console.log(err);
        return null;
      }
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        ...options,
        headers: {
          ...options.headers,
          accept: "application/json",
        },
      });

      if (!res.ok) {
        throw new Error(`Failed to fetch JSON due to ${res.status}`);
      }
      return await res.json();
    }

    async function renderChatWidget() {
      const userID = user?.localAccountId != null
        ? user.localAccountId.substr(0, 36)
        : (Math.random().toString() + Date.now().toString()).substr(0, 64);

      const { token } = await fetchJSON(tokenEndpoint);
      const directLine = window.WebChat.createDirectLine({ token });

      const store = WebChat.createStore(
        {},
        ({ dispatch }) => (next) => (action) => {
          const { type } = action;

          if (type === "DIRECT_LINE/CONNECT_FULFILLED") {
            dispatch({ type: "WEB_CHAT/DISABLE_SEND_BOX" });

            dispatch({
              meta: { method: "keyboard" },
              payload: {
                activity: {
                  channelData: { postBack: true },
                  from: {
                    id: userID,
                    name: user.name,
                    role: "user",
                  },
                  name: "startConversation",
                  type: "event",
                },
              },
              type: "DIRECT_LINE/POST_ACTIVITY",
            });
          }

          if (type === "DIRECT_LINE/INCOMING_ACTIVITY") {
            const activity = action.payload.activity;
            let resourceUri;

            if (activity.from && activity.from.role === "bot" &&
              (resourceUri = getOAuthCardResourceUri(activity))) {
              exchangeTokenAsync(resourceUri).then((token) => {
                if (token) {
                  directLine.postActivity({
                    type: "invoke",
                    name: "signin/tokenExchange",
                    value: {
                      id: activity.attachments[0].content.tokenExchangeResource.id,
                      connectionName: activity.attachments[0].content.connectionName,
                      token,
                    },
                    from: {
                      id: userID,
                      name: user.name,
                      role: "user",
                    },
                  }).subscribe(
                    (id) => {
                      if (id === "retry") {
                        dispatch({ type: "WEB_CHAT/ENABLE_SEND_BOX" });
                        return next(action);
                      }
                      dispatch({ type: "WEB_CHAT/ENABLE_SEND_BOX" });
                    },
                    (error) => {
                      dispatch({ type: "WEB_CHAT/ENABLE_SEND_BOX" });
                      return next(action);
                    }
                  );
                } else {
                  dispatch({ type: "WEB_CHAT/ENABLE_SEND_BOX" });
                  return next(action);
                }
              });
              return;
            }
          }

          return next(action);
        }
      );

      const styleOptions = {
        hideUploadButton: true,
        sendBoxTextWrap: true,
        backgroundColor: "#f2f3f5",
        bubbleFromUserBackground: "#133b6d",
        bubbleFromUserTextColor: "#ffffff",
        bubbleFromUserBorderRadius: 18,
        bubbleBackground: "#e9eff7",
        bubbleTextColor: "#000000",
        bubbleBorderRadius: 18,
        botAvatarInitials: "",
        botAvatarImage: "ser_Insight365_BotImage",
        botAvatarBackgroundColor: "#021838",
        userAvatarInitials: "",
        userAvatarBackgroundColor: "#021838",
        userAvatarImage: "ser_Insight365_UserImage",
        fontSize: "15px",
        fontFamily: `'Segoe UI', sans-serif`,
        sendBoxBackground: "#ffffff",
        sendBoxTextColor: "#000",
        sendBoxButtonColor: "#021838",
        sendBoxButtonColorOnFocus: "#0057b8",
      };

      window.WebChat.renderWebChat({
        directLine,                                   
        store,
        userID,
        styleOptions,
      }, document.getElementById("webchat"));
    }
  </script>
</body>
</html>
